# Dockerfile para ambiente de desenvolvimento - Coolify
# Versão simplificada e robusta

FROM node:18-alpine

# Instalar ferramentas necessárias
RUN apk add --no-cache git curl

WORKDIR /app

# Copiar todos os arquivos primeiro
COPY . .

# Instalar dependências em todos os diretórios
# Usar npm install para garantir compatibilidade
RUN cd shared && npm install --production=false && \
    cd ../charts-router && npm install --production=false && \
    cd ../trellis-chart && npm install --production=false && \
    cd ../boxplot-chart && npm install --production=false

# Build de todos os projetos
RUN cd charts-router && npm run build && \
    cd ../trellis-chart && npm run build && \
    cd ../boxplot-chart && npm run build

# Criar diretório de logs
RUN mkdir -p /app/logs && chmod 777 /app/logs

# Configurar variáveis de ambiente para desenvolvimento
ENV NODE_ENV=development
ENV PORT=3000
ENV ANALYTICS_ENABLED=true
ENV ANALYTICS_STORAGE_TYPE=file
ENV ANALYTICS_LOG_PATH=/app/logs/analytics-dev.jsonl

# Expor porta
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# Comando para iniciar a aplicação
CMD ["node", "charts-router/dist/server.js"]